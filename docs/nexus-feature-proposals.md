# Nexus 機能提案 — nexus-feature-proposals.md

> 最終更新: 2026-02-25
> 参照: [discord-tech-research.md](./discord-tech-research.md)

---

## 概要

Discord の技術調査に基づき、Nexus (Tauri 2 + WebView2 + LiveKit) で実装可能な機能・最適化を提案する。
現在のスタック: TypeScript/React + Webpack + LiveKit (VC) + Tauri 2 (デスクトップ)

---

## A. デスクトップアプリ特有の機能

### A-1. グローバルキーボードショートカット

| 項目 | 内容 |
|------|------|
| **機能名** | グローバルキーボードショートカット (Push-to-Talk, ミュートトグル等) |
| **Discord での実装** | Electron のネイティブモジュールでキーイベントをグローバルフック。ウィンドウ非フォーカスでも動作 |
| **Nexus での実装難易度** | **低** |
| **優先度** | **高** |
| **実装アプローチ** | Tauri 2 の `tauri-plugin-global-shortcut` を使用。JS/Rust 両方の API あり。`register` でキーコンビネーションを登録し、コールバックで `NexusVoiceStore` の `toggleMic()` / `toggleDeafen()` 等を呼ぶ。Push-to-Talk はキーダウン/キーアップイベントで実装。設定画面でキーバインドをカスタマイズ可能に |

### A-2. システムトレイ常駐

| 項目 | 内容 |
|------|------|
| **機能名** | システムトレイアイコン + メニュー + ウィンドウ閉じ時の常駐 |
| **Discord での実装** | Electron のシステムトレイ API。未読/メンションバッジ表示、右クリックメニュー、ウィンドウ閉じでトレイに最小化 |
| **Nexus での実装難易度** | **低** |
| **優先度** | **高** |
| **実装アプローチ** | Tauri 2 の `TrayIcon` API を使用。Rust 側で `TrayIconBuilder` を構築し、メニュー項目（表示/非表示、ミュート、切断、終了）を追加。`on_window_event` で CloseRequested をフックし、`window.hide()` でトレイ常駐。VC 接続中はアイコンにインジケーター表示 |

### A-3. Push-to-Talk (PTT)

| 項目 | 内容 |
|------|------|
| **機能名** | Push-to-Talk + PTT リリース遅延 |
| **Discord での実装** | グローバルキーフックでキーダウン=マイクオン、キーアップ=マイクオフ。リリース遅延スライダーで音声カット遅延を調整 |
| **Nexus での実装難易度** | **低〜中** |
| **優先度** | **高** |
| **実装アプローチ** | A-1 のグローバルショートカットと連携。`global-shortcut` プラグインでキーダウン/キーアップを検知し、`NexusVoiceConnection.setMicMuted()` を呼ぶ。既存のボイスゲートと排他設定に。リリース遅延は既存の 300ms リリース遅延ロジック（ボイスゲート用）を転用可能。設定画面に入力モード切替（音声検出/PTT）を追加 |

### A-4. In-Game オーバーレイ (簡易版)

| 項目 | 内容 |
|------|------|
| **機能名** | VC 参加者のコンパクトオーバーレイ表示 |
| **Discord での実装** | ゲームのレンダリングパイプラインに DLL インジェクト、DirectX/OpenGL/Vulkan フックでオーバーレイ描画 |
| **Nexus での実装難易度** | **中** |
| **優先度** | **中** |
| **実装アプローチ** | Discord 方式の DLL インジェクトは困難。代替として Tauri 2 の別ウィンドウを使用: `always_on_top: true` + `transparent: true` + `decorations: false` で透過オーバーレイウィンドウを作成。VC 参加者リスト + 発話インジケーターのみを描画。`ignore_cursor_events: true` でクリックスルー対応。ボーダレスウィンドウのゲームでは動作、フルスクリーン排他では非動作。トグルキーバインドで表示/非表示 |

### A-5. 自動起動 (Launch on Boot)

| 項目 | 内容 |
|------|------|
| **機能名** | OS 起動時の自動起動 |
| **Discord での実装** | Electron の auto-launch 機能。レジストリ/plist/autostart エントリ登録 |
| **Nexus での実装難易度** | **低** |
| **優先度** | **中** |
| **実装アプローチ** | Tauri 2 の `tauri-plugin-autostart` を使用。`builder.plugin(tauri_plugin_autostart::init(MacosLauncher::LaunchAgent, None))` で初期化。設定画面にトグル追加。システムトレイ常駐（A-2）と組み合わせてバックグラウンド起動 |

### A-6. ネイティブ通知

| 項目 | 内容 |
|------|------|
| **機能名** | OS ネイティブ通知 (メンション、DM、VC 参加通知) |
| **Discord での実装** | Electron の Notification API + OS ネイティブ通知センター。フォーカス時は抑制 |
| **Nexus での実装難易度** | **低** |
| **優先度** | **高** |
| **実装アプローチ** | Tauri 2 の `tauri-plugin-notification` を使用。Matrix イベント受信時（`MatrixClient.on("Room.timeline")` 等）に `sendNotification()` を呼ぶ。@メンション / DM / VC 参加イベントをフィルタリング。ウィンドウフォーカス時は抑制 (`window.isFocused()`)。通知クリックでチャンネルにフォーカス |

---

## B. 音声/映像品質改善

### B-1. 高度ノイズキャンセリング (DTLN)

| 項目 | 内容 |
|------|------|
| **機能名** | DTLN ベースの AI ノイズキャンセリング |
| **Discord での実装** | Krisp SDK（C++ネイティブ/WASM）。DNN ベースで非音声ノイズを除去。デスクトップはネイティブ、ブラウザは WASM |
| **Nexus での実装難易度** | **高** |
| **優先度** | **中** |
| **実装アプローチ** | 既存メモリノートの dtln-rs (Datadog製) を使用。Rust→WASM ビルドし `AudioWorkletProcessor` で実装。16kHz リサンプリングが必要だが、Tauri 2 では Rust サイドで直接音声処理する選択肢もある（WebView を経由しない UDP パス）。段階的に: (1) 現行 RNNoise 維持 → (2) DTLN WASM 追加 → (3) 失敗時は RNNoise フォールバック → NC オフの3段構え。Krisp SDK は非公開のため直接利用不可 |

### B-2. Rust ネイティブ音声パイプライン

| 項目 | 内容 |
|------|------|
| **機能名** | Rust サイドでの音声処理パイプライン |
| **Discord での実装** | C++ ネイティブメディアエンジン（WebRTC ネイティブライブラリベース）。VAD、auto-ducking バイパス、カスタム音量制御 |
| **Nexus での実装難易度** | **高** |
| **優先度** | **低** (Phase 4 以降) |
| **実装アプローチ** | Tauri 2 の Rust バックエンドで `cpal` (クロスプラットフォーム音声) + `opus` (エンコード/デコード) + `webrtc-rs` を使用。UDP ソケットで直接 LiveKit SFU と通信。Web Audio API のレイテンシ（~10ms オーバーヘッド）を排除。>100% マスターボリュームも実現可能。ただし LiveKit のシグナリングプロトコルとの互換性確保が最大の課題 |

### B-3. VAD (音声アクティビティ検出) の改善

| 項目 | 内容 |
|------|------|
| **機能名** | より精度の高い音声アクティビティ検出 |
| **Discord での実装** | 生オーディオアクセス + ネイティブ VAD。Krisp と連携して発話/非発話を高精度分類 |
| **Nexus での実装難易度** | **中** |
| **優先度** | **中** |
| **実装アプローチ** | 現在は `inputLevel > 5` の単純閾値。改善案: (1) RMS ではなくスペクトル分析（人声の 300Hz-3kHz 帯域を重み付け）(2) 短時間エネルギーのヒストグラムベース適応閾値 (3) WebAssembly で軽量 VAD モデル (Silero VAD 等) を実行。ボイスゲートとの統合で false positive/negative を削減 |

### B-4. エコーキャンセレーション強化

| 項目 | 内容 |
|------|------|
| **機能名** | スピーカー使用時のエコーキャンセレーション改善 |
| **Discord での実装** | ネイティブエンジンでの AEC 実装 + Krisp 連携 |
| **Nexus での実装難易度** | **低〜中** |
| **優先度** | **中** |
| **実装アプローチ** | 現在ブラウザの `echoCancellation: true` に依存。Tauri 2 では: (1) `getUserMedia` の `echoCancellation` / `noiseSuppression` / `autoGainControl` を明示的に制御する設定 UI を追加 (2) 問題発生時の診断ログ出力 (3) 将来的には Rust 側で WebRTC の AEC3 アルゴリズムを直接利用 |

### B-5. Opus エンコーディング最適化

| 項目 | 内容 |
|------|------|
| **機能名** | Opus コーデック設定の最適化 |
| **Discord での実装** | Opus ステレオ 48kHz + 帯域に応じた動的ビットレート調整 |
| **Nexus での実装難易度** | **低** |
| **優先度** | **中** |
| **実装アプローチ** | LiveKit の `AudioPresets` を活用し、用途別のプリセットを提供: (1) 通常会話: モノラル 48kHz 32kbps (2) 音楽共有: ステレオ 48kHz 128kbps (3) 画面共有音声: ステレオ 48kHz 64kbps。設定画面で「音声モード」として切替可能に。`publishOptions.audioEncoding` で制御 |

---

## C. パフォーマンス最適化

### C-1. コード分割 (遅延読み込み) の改善

| 項目 | 内容 |
|------|------|
| **機能名** | ルートベースのコード分割強化 |
| **Discord での実装** | 初期ロード ~700KB。ルート/スタイルシート/アニメーション/翻訳を遅延読み込み。makeLazy ローダーでリトライ |
| **Nexus での実装難易度** | **中** |
| **優先度** | **中** |
| **実装アプローチ** | Element Web は既に Webpack を使用しているが、Nexus カスタムコンポーネントの遅延読み込みは未対応。(1) `NexusVCRoomView` / `NexusVoiceParticipantGrid` 等の VC 系コンポーネントを `React.lazy()` + `Suspense` でラップ (2) VC 未使用時は livekit-client のチャンクをロードしない (3) 設定画面の各タブを個別チャンクに分割 |

### C-2. メッセージリストの仮想化改善

| 項目 | 内容 |
|------|------|
| **機能名** | メッセージリスト/メンバーリストの仮想スクロール最適化 |
| **Discord での実装** | カスタム仮想化ライブラリ (FastList/FastestList)。チャット・メンバーリスト・絵文字で仮想化 |
| **Nexus での実装難易度** | **中〜高** |
| **優先度** | **低** |
| **実装アプローチ** | Element Web は独自の仮想スクロール実装を持つ。大幅変更はリスクが高い。代替案: (1) 既存の仮想スクロールの問題点を特定 (2) メッセージコンポーネントのメモ化 (`React.memo`) を徹底 (3) 大量のリアクション/埋め込みがあるメッセージの遅延レンダリング (4) 将来的に TanStack Virtual への移行を検討 |

### C-3. 画像フォーマット最適化

| 項目 | 内容 |
|------|------|
| **機能名** | WebP/AVIF 画像の優先表示 |
| **Discord での実装** | Lilliput (画像処理ライブラリ) + メディアプロキシ (Rust) でオンザフライ変換。絵文字 WebP 化で 29% サイズ削減 |
| **Nexus での実装難易度** | **低** |
| **優先度** | **低** |
| **実装アプローチ** | Matrix のメディアサーバー (Synapse) は画像変換をサポート。クライアント側で: (1) `<img>` / `<picture>` タグで WebP/AVIF を `srcset` で優先指定 (2) アバターのサムネイル生成時に小サイズを要求 (3) Matrix CS API の `?width=&height=&method=scale` パラメータ活用。サーバーサイドの変換に依存するため、自前プロキシは不要 |

### C-4. アプリ起動時間の短縮

| 項目 | 内容 |
|------|------|
| **機能名** | Tauri アプリの起動時間最適化 |
| **Discord での実装** | Electron で 1-2秒の起動。64bit 移行、コード分割で最小初期ロード |
| **Nexus での実装難易度** | **中** |
| **優先度** | **中** |
| **実装アプローチ** | Tauri 2 はベースラインで 500ms 以下の起動が可能。最適化: (1) Rust 側でスプラッシュスクリーンを表示しつつ WebView をバックグラウンド初期化 (2) WebView のプリウォームアップ（Windows の WebView2 Runtime は初回起動が遅い場合がある）(3) 初期 HTML/CSS/JS をインラインバンドル (4) Matrix sync を非同期にし UI 表示を先行 |

---

## D. UX 改善

### D-1. ユーザーステータス / プレゼンス強化

| 項目 | 内容 |
|------|------|
| **機能名** | カスタムステータス、DND、不在表示 |
| **Discord での実装** | Gateway WebSocket でプレゼンス更新をリアルタイム配信。Online/Idle/DND/Invisible + カスタムステータス文言 |
| **Nexus での実装難易度** | **低** |
| **優先度** | **中** |
| **実装アプローチ** | Matrix は `m.presence` イベントを標準サポート。matrix-js-sdk で `client.setPresence("online" | "unavailable" | "offline")` が使える。(1) UserPanel にステータスセレクター追加 (2) メンバーリストでステータスアイコン表示 (3) カスタムステータスは `m.custom_status` イベントとして実装可能 |

### D-2. VC チャンネルの接続状態バー改善

| 項目 | 内容 |
|------|------|
| **機能名** | VC 接続品質インジケーター |
| **Discord での実装** | 緑/黄/赤のバーで接続品質を表示。ping 値、パケットロス、ジッター表示 |
| **Nexus での実装難易度** | **低** |
| **優先度** | **高** |
| **実装アプローチ** | 既存の `RTCPeerConnection.getStats()` ベースの ping 表示を拡張。(1) `NexusCallStatusPanel` にカラーインジケーター追加（<50ms=緑, <150ms=黄, 150ms+=赤）(2) クリックで詳細ポップオーバー表示（ping, jitter, packetLoss, codec 情報）(3) `getStats()` から `jitter` / `packetsLost` / `bytesReceived` 等を取得 |

### D-3. 未読管理の改善

| 項目 | 内容 |
|------|------|
| **機能名** | チャンネル別未読インジケーター + メンションバッジ |
| **Discord での実装** | 赤バッジ (メンション)、白ドット (未読)。チャンネル単位の通知設定オーバーライド |
| **Nexus での実装難易度** | **低** |
| **優先度** | **中** |
| **実装アプローチ** | Element Web は既に未読カウントを持つ。Nexus の `NexusChannelListView` で: (1) メンションバッジ（赤丸+数字）を追加 (2) 未読チャンネル名を太字化 (3) 未読ドット（白/赤）をチャンネル名の左に表示 (4) 右クリックで「既読にする」コンテキストメニュー |

### D-4. メッセージ入力の改善

| 項目 | 内容 |
|------|------|
| **機能名** | タイピングインジケーター、メンション補完の改善 |
| **Discord での実装** | 「○○ が入力中...」表示。@メンション / #チャンネル / :絵文字: の補完ポップアップ |
| **Nexus での実装難易度** | **低** |
| **優先度** | **低** |
| **実装アプローチ** | Element Web は基本的な補完とタイピングインジケーターを持つ。改善: (1) タイピングインジケーターの UI を Discord 風に変更（メッセージ入力欄の下に表示）(2) 補完ポップアップのスタイルを Discord 風に調整 |

### D-5. スレッド/リプライの Discord 風表示

| 項目 | 内容 |
|------|------|
| **機能名** | リプライ時の引用表示改善 |
| **Discord での実装** | リプライ先メッセージをコンパクトに引用表示。クリックで元メッセージにジャンプ |
| **Nexus での実装難易度** | **低** |
| **優先度** | **低** |
| **実装アプローチ** | Element Web のリプライ表示は既に類似の UX。CSS 調整で Discord 風のデザインに近づける: (1) リプライ元の左側に縦線表示 (2) リプライ元のアバター+名前+本文プレビューをコンパクト化 |

---

## E. セキュリティ

### E-1. E2EE 音声/映像の検証 UI

| 項目 | 内容 |
|------|------|
| **機能名** | VC の E2EE 状態表示と参加者検証 |
| **Discord での実装** | DAVE プロトコル。MLS 鍵交換、Voice Privacy Code による検証、エポック管理 |
| **Nexus での実装難易度** | **高** |
| **優先度** | **低** |
| **実装アプローチ** | LiveKit は E2EE をサポートしているが、DAVE プロトコルとは異なる実装。(1) LiveKit の E2EE 機能を有効化 (`E2EEOptions` の設定) (2) VC コントロールバーに鍵アイコンで E2EE 状態表示 (3) 参加者コンテキストメニューに検証コード表示。Matrix のテキスト暗号化 (Olm/Megolm) との統一 UX を検討 |

---

## F. メディアとコンテンツ

### F-1. 画面共有の品質設定 UI

| 項目 | 内容 |
|------|------|
| **機能名** | 画面共有時の解像度/FPS/ビットレート設定 |
| **Discord での実装** | 品質プリセット（720p30, 1080p30, 1080p60）。帯域に応じた動的品質調整。Nitro で上限解放 |
| **Nexus での実装難易度** | **低** |
| **優先度** | **高** |
| **実装アプローチ** | 現在は 720p30 固定。改善: (1) 画面共有開始時にプリセット選択 UI を表示（720p30 / 1080p30 / 1080p60）(2) `ScreenSharePresets` を切替えて `publishOptions` に反映 (3) 配信中のビットレート/FPS をリアルタイム表示 (4) ソース選択 UI の改善（個別ウィンドウ/画面全体の選択） |

### F-2. アニメーション画像の最適化

| 項目 | 内容 |
|------|------|
| **機能名** | GIF → WebP 変換、Reduced Motion 対応 |
| **Discord での実装** | 全アニメーション絵文字を WebP で配信。ファイルサイズ 29-42% 削減。60fps 表示 |
| **Nexus での実装難易度** | **低** |
| **優先度** | **低** |
| **実装アプローチ** | Matrix サーバー依存の部分が大きいが: (1) カスタム絵文字/スタンプ機能追加時に WebP を推奨 (2) `prefers-reduced-motion` メディアクエリで静止画表示オプション (3) インラインメディアの遅延読み込みで初期レンダリング高速化 |

---

## 優先度別サマリー

### 高優先度（ユーザー体験に大きく影響、実装難易度低め）

| ID | 機能名 | 難易度 |
|----|--------|--------|
| A-1 | グローバルキーボードショートカット | 低 |
| A-2 | システムトレイ常駐 | 低 |
| A-3 | Push-to-Talk | 低〜中 |
| A-6 | ネイティブ通知 | 低 |
| D-2 | VC 接続品質インジケーター | 低 |
| F-1 | 画面共有の品質設定 UI | 低 |

### 中優先度（体験向上するが実装に一定のコスト）

| ID | 機能名 | 難易度 |
|----|--------|--------|
| A-4 | In-Game オーバーレイ (簡易版) | 中 |
| A-5 | 自動起動 | 低 |
| B-1 | 高度ノイズキャンセリング (DTLN) | 高 |
| B-3 | VAD の改善 | 中 |
| B-4 | エコーキャンセレーション強化 | 低〜中 |
| B-5 | Opus エンコーディング最適化 | 低 |
| C-1 | コード分割の改善 | 中 |
| C-4 | アプリ起動時間の短縮 | 中 |
| D-1 | ユーザーステータス強化 | 低 |
| D-3 | 未読管理の改善 | 低 |

### 低優先度（将来検討 or 現状で十分）

| ID | 機能名 | 難易度 |
|----|--------|--------|
| B-2 | Rust ネイティブ音声パイプライン | 高 |
| C-2 | メッセージリストの仮想化改善 | 中〜高 |
| C-3 | 画像フォーマット最適化 | 低 |
| D-4 | メッセージ入力の改善 | 低 |
| D-5 | スレッド/リプライの Discord 風表示 | 低 |
| E-1 | E2EE 音声/映像の検証 UI | 高 |
| F-2 | アニメーション画像の最適化 | 低 |

---

## 推奨実装順序

### Phase 3.1: デスクトップ基本機能

1. **A-2** システムトレイ常駐
2. **A-1** グローバルキーボードショートカット
3. **A-3** Push-to-Talk
4. **A-6** ネイティブ通知
5. **A-5** 自動起動

理由: Tauri 2 プラグインで簡単に実装でき、デスクトップアプリとしての基本体験を確立する。

### Phase 3.2: VC 品質向上

1. **D-2** VC 接続品質インジケーター
2. **F-1** 画面共有の品質設定 UI
3. **B-5** Opus エンコーディング最適化
4. **B-3** VAD の改善
5. **B-4** エコーキャンセレーション強化

理由: 音声/映像の体験品質を段階的に向上させる。

### Phase 3.3: UX 改善 + パフォーマンス

1. **D-1** ユーザーステータス強化
2. **D-3** 未読管理の改善
3. **C-1** コード分割の改善
4. **C-4** アプリ起動時間の短縮
5. **A-4** In-Game オーバーレイ (簡易版)

### Phase 4 (将来): ネイティブ高度機能

1. **B-1** DTLN ノイズキャンセリング
2. **B-2** Rust ネイティブ音声パイプライン
3. **E-1** E2EE 音声/映像の検証 UI
