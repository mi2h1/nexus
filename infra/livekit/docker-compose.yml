services:
  livekit:
    image: livekit/livekit-server:latest
    container_name: nexus-livekit
    restart: always
    # WebSocket is proxied through nginx, only expose TCP/UDP directly
    ports:
      - "7881:7881"       # TCP TURN fallback
      - "7882:7882/udp"   # WebRTC media (UDP)
    volumes:
      - /etc/ssl/lche2:/etc/ssl/lche2:ro
      - ./livekit.yaml:/etc/livekit.yaml:ro
    command: --config /etc/livekit.yaml
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  lk-jwt-service:
    image: nexus-lk-jwt-service:latest
    container_name: nexus-jwt
    restart: always
    volumes:
      - ./data:/data
    environment:
      # Public URL — returned to clients in JWT response so they can connect
      LIVEKIT_URL: "wss://lche2.xvps.jp:7880"
      # API credentials — must match livekit.yaml keys
      LIVEKIT_KEY: "nexus-api"
      LIVEKIT_SECRET: "0930254ce08f85941dd721f2eea601d1941d2353810367fdd94f758c78b5fd11"
      # Trust matrix.org for OpenID token verification
      LIVEKIT_FULL_ACCESS_HOMESERVERS: "matrix.org"
      # Whitelist of Matrix user IDs allowed to get JWT tokens
      LIVEKIT_ALLOWED_USER_IDS: "@mi2h:matrix.org,@lche:matrix.org,@yama_yu:matrix.org,@makotu510:matrix.org,@msyumallow:matrix.org,@1stbloodkyo:matrix.org,@mohumo:matrix.org"
    depends_on:
      - livekit
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"

  # Nginx: TLS termination for LiveKit WSS + JWT HTTPS
  nginx:
    image: nginx:alpine
    container_name: nexus-nginx
    restart: always
    ports:
      - "7880:7880"   # WSS → LiveKit WebSocket
      - "7891:7891"   # HTTPS → JWT service
    volumes:
      - /etc/ssl/lche2:/etc/ssl/lche2:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - livekit
      - lk-jwt-service
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"
